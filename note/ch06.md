# 6章 項の名無し表現（Nameless Representation of Terms）

```toc
```
## はじめに
前章では，項を「束縛変数の名前の違いを除いて」扱った．

（例）
```mathjaxBlock
\begin{align}
\left.
  \begin{array}{ll}
  \mathtt{t}_{1} &=\lambda\mathtt{a}.\ \mathtt{a} \\
  \mathtt{t}_{2} &=\lambda\mathtt{b}.\ \mathtt{b}
  \end{array}
\right\}
\mathtt{t}_{1}と\mathtt{t}_{2}は束縛変数の名前が違うだけなので，
\mathtt{t}_{1}=\mathtt{t}_{2}
\end{align}
```

### 変数の出現に対する表現方法

1. 変数を記号的に表現する
代入の際に束縛変数を明示的に **フレッシュ** な名前に置き換える．
```mathjaxBlock
\begin{align}
                               & \underline{(\lambda\mathtt{x}.\ \mathtt{x}\ \mathbf{y})(\lambda\mathtt{y}.\ \mathtt{y})} & 項として存在できる \\
\longrightarrow\quad           & (\lambda\mathtt{y}.\ \mathtt{y}\ \mathbf{y})                                             & 変数捕獲が起きる   \\
\longrightarrow_{名前変更}\quad& (\lambda\mathtt{z}.\ \mathtt{z}\ \mathbf{y})                                                                  \\
\end{align}
```
2. 変数を記号的に表現する（1よりも厳しい）
    - 不変条件1: 束縛変数の名前はすべて互いに異なる
    `$(\lambda\underline{\mathtt{x}}.\ \mathtt{x})(\lambda\underline{\mathtt{x}}.\ \mathtt{x})$` ... だめ
    - 不変条件2: 使う可能性のあるどの自由変数とも異なる
    `$(\lambda\mathtt{x}.\ \mathtt{x}\ \underline{\mathtt{y}})(\lambda\underline{\mathtt{y}}.\ \mathtt{y})$` ... だめ
この慣習はBarendregtの慣習とも呼ばれ，任意の時点での「その場での」名前の付替えを許容しない．
しかし，安定ではない．なぜなら，代入操作は代入される項の複製を伴うから．
```mathjaxBlock
\begin{align}
                               & \underline{(\lambda\mathtt{x}.\ \mathtt{x}\ \mathtt{x})(\lambda\mathtt{y}.\ \mathtt{y})}                                      \\
\longrightarrow\quad           & (\lambda\underline{\mathtt{y}}.\ \mathtt{y})(\lambda\underline{\mathtt{y}}.\ \mathtt{y}) & 不変条件を回復するための処理が必要 \\
\longrightarrow_{名前変更}\quad&  (\lambda\mathtt{y}'.\ \mathtt{y}')(\lambda\mathtt{y}''.\ \mathtt{y}'')
\end{align}
```
3. 名前を変更する必要のない，変数および項の「標準の」表現を考える（ **名前をなくす** ）
→本書の方針
4. 明示的代入などの仕組みを導入することで，代入操作を避ける（ **代入をなくす** ）
5. 変数の使用を完全に避ける
コンビネータ論理を扱う．コンビネータとは自由変数を含まない項（閉じた項）のこと．
```mathjaxBlock
\begin{align}
                    & \underline{(\lambda\mathtt{x}.\ \mathtt{y}\ \mathtt{x}\ \mathtt{y})(\lambda\mathtt{y}.\ \mathtt{y})}    \\
\longrightarrow\quad& \lambda\mathtt{y}.\ (\lambda\mathbf{y}.\ \mathbf{y})\ \mathtt{y} & スコープが異なるから大丈夫なのかな？ \\
\end{align}
```

- 本書で3の表現方法を選ぶ理由
実装が間違っている場合に，微妙に失敗するのではなく，
**壊滅的に失敗** する傾向があるため．
すなわち，比較的早く間違いを検出し，修正できる．
定式化の方法として，Nicolas de Bruijn による技法を用いる．

## 6.1 項と文脈
アイデア！: 変数の出現を **名前** ではなく， **束縛子を直接指す** ことで項を表現

（例）

|通常の項                                                     |名無し項（内側から番号を振る）                            |
|:------------------------------------------------------------|:---------------------------------------------------------|
|`$\lambda\mathtt{x}.\ \mathtt{x}$`                           |`$\lambda.\ \mathtt{0}$`                                  |
|`$\lambda\mathtt{x}.\ \lambda{y}.\ (\mathtt{y}\ \mathtt{x})$`|`$\lambda.\lambda.\ \mathtt{1}\ (\mathtt{0}\ \mathtt{1})$`|

名無し項は，de Bruijn 項とも呼ばれる．
`$\lambda.\ \mathtt{0}$` の `$\mathtt{0}$` はde Bruijnインデックス（自然数）と呼ばれ，
コンパイラの人は静的距離とも呼ぶ．

### 演習 6.1.1 (`$\star$`)

### 定義 6.1.2
`$\mathcal{T}$` を以下の条件を満たす集合の最小の族 `$\{\mathcal{T}_{0}, \mathcal{T}_{1}, \mathcal{T}_{2}, \ldots\}$` とする．
1. `$0 \leq \mathtt{k} < n$` ならば `$\mathtt{k} \in \mathcal{T}_{n}$`
    - `$\mathtt{k}$` は自由変数（識別子）
2. `$\mathtt{t}_{1} \in \mathcal{T}_{n}$` かつ `$n > 0$` ならば `$\lambda.\mathtt{t}_{1} \in \mathcal{T}_{n-1}$`
    - （前件）自由変数を最大で `$n$` 個含む項 `$\mathtt{t}_{1}$`に
    - （後件）`$\lambda$` を付けると自由変数を一つ束縛するので，`$\lambda.\mathtt{t}_{1}$` は `$\mathcal{T}_{n-1}$`に属する
3. `$\mathtt{t}_{1} \in \mathcal{T}_{n}$` かつ `$\mathtt{t}_{2} \in \mathcal{T}_{n}$` ならば `$(\mathtt{t}_{1}\ \mathtt{t}_{2}) \in \mathcal{T}_{n}$`

（例）
```mathjaxBlock
\begin{align}
\mathcal{T}_{0}=& \quad \{\lambda.\mathtt{0},\ \lambda.\lambda.\mathtt{1},\ \ldots\}                                     & 自由変数0の集合 \\
\mathcal{T}_{1}=& \quad \{\lambda.\mathtt{x},\ \lambda.\lambda.\mathtt{y},\ \lambda.\mathtt{0}\ \mathtt{z}\ldots\}       & 自由変数1の集合 \\
\mathcal{T}_{2}=& \quad \{\lambda.\mathtt{x}\ \mathtt{y},\ \lambda.\mathtt{0},\ \lambda.\mathtt{z}\ \mathtt{y},\ \ldots\}& 自由変数2の集合 \\
                & \vdots                                                                                                 &                 \\
\mathcal{T}_{n}=& \quad \{\ldots\}                                                                                       & 自由変数nの集合 \\
\end{align}
```

注意点
- 一つの集合を定義しているのではない
- 数で添字付けられた **集合族** を定義している

`$\mathcal{T}_{n}$` を `$n$` 項と呼ぶ
- 高々 `$n$` 種類の自由変数を持つ
- `$0$` から `$n-1$` の数が振られる
- `$\mathcal{T}_{n}$` の要素に **`$0$` から `$n-1$` までのすべての数が振られた自由変数が含まれる必要はない**
（例）
```mathjaxBlock
\begin{align}
\mathcal{T}_{2}=& \quad \{\lambda.\mathtt{x},\ \lambda.\lambda.\mathtt{x}\ \mathtt{y},\ \ldots,\ \lambda.\mathtt{0}\ \mathtt{x},\ \lambda.\mathtt{0},\ \ldots\}
\end{align}
```

- 閉じた項 `$\mathtt{t}$` は任意の `$n$` について `$\mathcal{T}_{n}$` に属する
- 閉じた通常の項はそれぞれ唯一の de Bruijn 表現を持つ
```mathjaxBlock
\begin{align}
\lambda\mathtt{x}.\ \mathtt{x} \longrightarrow \lambda.\mathtt{0}
\end{align}
```
- 2つの通常の項を考えたとき，束縛変数名の違いを無視して等しい（⇔ de Bruijn 表現も等しい）
```mathjaxBlock
\begin{align}
\lambda\mathtt{x}.\ \mathtt{x} \longrightarrow \lambda.\mathtt{0} \\
\lambda\mathtt{y}.\ \mathtt{y} \longrightarrow \lambda.\mathtt{0}
\end{align}
```

|                                              |自由変数                                         |束縛変数                 |
|:---------------------------------------------|:------------------------------------------------|:------------------------|
|`$\lambda\mathtt{x}.\ \mathtt{x}$`            |--                                               |`$\mathtt{x}=\mathtt{0}$`|
|`$\lambda\mathtt{x}.\ \mathtt{x}\ \mathtt{y}$`|`$\mathtt{y}=\mathtt{0}$`                        |`$\mathtt{x}=\mathtt{0}$`|
|`$\lambda\mathtt{x}.\ \mathtt{y}\ \mathtt{z}$`|`$\mathtt{y}=\mathtt{0},\ \mathtt{z}=\mathtt{1}$`|`$\mathtt{x}=\mathtt{0}$`|


**名前付け文脈** は **自由変数を含む項を扱う** ために必要

（例）`$\mathtt{y}$` が何番であるか分からない
```mathjaxBlock
\begin{align}
\lambda\mathtt{x}.\ \mathtt{y}\ \mathtt{x} \longrightarrow \lambda.\ \mathtt{y}\ \mathtt{0}
\end{align}
```

**解決策**
自由変数の de Bruijn インデックスの割り当て方（名前付け文脈）決めておく

（例）

```mathjaxBlock
\begin{align}
\Gamma &&= && \mathtt{x} \mapsto 4 \\
       &&  && \mathtt{y} \mapsto 3 \\
       &&  && \mathtt{z} \mapsto 2 \\
       &&  && \mathtt{a} \mapsto 1 \\
       &&  && \mathtt{b} \mapsto 0
\end{align}
```

```mathjaxBlock
\begin{align}
\mathtt{x}\ \mathtt{(y}\ \mathtt{z)} \longrightarrow              & \quad\mathtt{4}\ \mathtt{(3}\ \mathtt{2)} \\
                                                                                                              \\
\lambda\mathtt{w}.\ \mathtt{y}\ \mathtt{w} \longrightarrow        & \quad\lambda.\mathtt{y}\ \mathtt{0}       \\
                                           \longrightarrow        & \quad\lambda.(\mathtt{3+1})\ \mathtt{0}   \\
                                           \longrightarrow        & \quad\lambda.\mathtt{4}\ \mathtt{0}       \\
                                                                                                              \\
\lambda\mathtt{w}.\ \lambda\mathtt{x}.\ \mathtt{x} \longrightarrow& \quad\lambda.\lambda.(\mathtt{4+2})       \\
                                                   \longrightarrow& \quad\lambda.\lambda.\mathtt{6}
\end{align}
```

変数のインデックスは `$\Gamma$` に出現する順序で決まるので，列として書くことができる．

```mathjaxBlock
\begin{align}
\begin{array}{ll}
\Gamma &= &\mathtt{x} \mapsto 4 \\
       &  &\mathtt{y} \mapsto 3 \\
       &  &\mathtt{z} \mapsto 2 \\
       &  &\mathtt{a} \mapsto 1 \\
       &  &\mathtt{b} \mapsto 0
\end{array}
\quad
\xrightarrow{列の表現}
\quad
\begin{array}{llllll}
\Gamma &= &\mathtt{x}, &\mathtt{y}, &\mathtt{z}, &\mathtt{a}, &\mathtt{b} \\
       &  &4           &3           &2           &1           &0
\end{array}
\end{align}
```

### 定義 6.1.3
- `$\mathtt{x}_{0}$` から `$\mathtt{x}_{n}$` を `$\mathcal{V}$` から取ってきた変数名とする
- 名前付け文脈 `$\Gamma = \mathtt{x}_{n},\mathtt{x}_{n-1},\ldots,\mathtt{x}_{1},\mathtt{x}_{0}$` とは，各 `$\mathtt{x}_{i}$` に de Bruijn インデックス `$i$` を割り振ったものである
- 列の中で **右端にある変数に `$0$`** を与える

```mathjaxBlock
\begin{align}
dom(\Gamma) = \{\mathtt{x}_{n},\mathtt{x}_{n-1},\ldots,\mathtt{x}_{1},\mathtt{x}_{0}\}
\end{align}
```

### 演習 6.1.4 (`$\star\star\star\nrightarrow$`)
### 演習 6.1.5 (Recommended, `$\star\star\star$`)
